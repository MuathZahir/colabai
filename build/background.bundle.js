(()=>{"use strict";var e,t={d:(e,n)=>{for(var s in n)t.o(n,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:n[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},n={};t.r(n),t.d(n,{xX:()=>Ce,qA:()=>ke,LG:()=>Oe,cH:()=>Pe,v3:()=>Te,v7:()=>Re,fK:()=>$e,pf:()=>Fe,PO:()=>qe,k5:()=>Be,m_:()=>Ne,vc:()=>Ie,Ll:()=>De,OE:()=>je,Is:()=>Me});class s{static simplifyCode(e){if(!e)return"";return this.applySimplificationRules(e).trim()}static applySimplificationRules(e){const t=this.removeParenthesesContent(e),n=this.simplifyFunctionImplementations(t),s=this.removeComments(n);return this.additionalSimplifications(s)}static removeParenthesesContent(e){return e.replace(/\((?:[^)(]*|\((?:[^)(]*|\([^)(]*\))*\))*\)/g,"(...)")}static simplifyFunctionImplementations(e){return e.replace(/((def|class)\s+\w+\s*\([^)]*\))\s*:[\s\S]*?(?=\n\S|\Z)/gm,((e,t)=>{const n=t.split(":")[0]+":";return t.startsWith("class"),n+"\n    ..."}))}static removeComments(e){return e.replace(/#.*$/gm,"").replace(/"""[\s\S]*?"""/g,"").replace(/'''[\s\S]*?'''/g,"")}static additionalSimplifications(e){return e.replace(/^\s+$/gm,"").replace(/\n{3,}/g,"\n\n").split("\n").map((e=>e.trim())).filter((e=>e.length>0)).join("\n")}}class r{constructor(){this.lastState=new Map,this.cellOrder=[]}updateState(e){const t=new Map,n=[],s=[];return e.forEach(((e,s)=>{t.set(e.id,{id:e.id,type:e.type,content:e.content,index:s}),n.push(e.id)})),this.cellOrder=n,s.push(...this.detectAddedCells(t)),s.push(...this.detectRemovedCells(t)),s.push(...this.detectModifiedCells(t)),s.push(...this.detectMovedCells(n,t)),this.lastState=t,this.cellOrder=n,this.formatChangesForAI(s)}detectAddedCells(e){const t=[];return e.forEach(((e,n)=>{this.lastState.has(n)||t.push({type:"add",cell:e,position:this.determineRelativePosition(e.index)})})),t}detectRemovedCells(e){const t=[];return this.lastState.forEach(((n,s)=>{e.has(s)||t.push({type:"remove",cellId:s})})),t}detectModifiedCells(e){const t=[];return e.forEach(((e,n)=>{const s=this.lastState.get(n);s&&s.content!==e.content&&t.push({type:"modify",cellId:n,oldContent:s.content,newContent:e.content})})),t}detectMovedCells(e,t){const n=[],s=new Map;return this.cellOrder.forEach(((e,t)=>{s.set(e,t)})),e.forEach(((e,t)=>{const r=s.get(e);void 0!==r&&r!==t&&n.push({type:"move",cellId:e,position:this.determineRelativePosition(t)})})),n}determineRelativePosition(e){if(0===e)return"top";if(e===this.cellOrder.length)return"bottom";return`after:${this.cellOrder[e-1]}`}formatChangesForAI(e){let t="@CHANGELOG\n";return e.forEach((e=>{switch(e.type){case"add":const n=e;t+=`@ADDED[id=${n.cell.id}, type=${n.cell.type}, position=${n.position}]\n`,t+=n.cell.content+"\n",t+="@END\n\n";break;case"remove":t+=`@REMOVED[${e.cellId}]\n\n`;break;case"modify":const s=e;t+=`@MODIFIED[${s.cellId}]\n`,t+="--- Previous content ---\n",t+=s.oldContent+"\n",t+="--- New content ---\n",t+=s.newContent+"\n",t+="@END\n\n";break;case"move":const r=e;t+=`@MOVED[${r.cellId}, position=${r.position}]\n\n`}})),t+="@END_CHANGELOG",t}getLastState(e=[],t=!0){const n=Array.from(this.lastState.values()).map((n=>{const r=e.includes(n.id)?n.content:t&&"code"===n.type?s.simplifyCode(n.content):n.content;return{id:n.id,type:n.type,content:r}}));return JSON.stringify(n)}}!function(e){e.UNKNOWN="unknown",e.NETWORK="network",e.SERVER="server",e.AUTHENTICATION="authentication",e.INVALID_REQUEST="invalid_request",e.QUOTA_EXCEEDED="quota_exceeded",e.MODEL_ACCESS="model_access",e.CONFIGURATION="configuration",e.GENERATION_IN_PROGRESS="generation_in_progress",e.RATE_LIMIT="rate_limit"}(e||(e={}));class o extends Error{constructor(e){super(e.message),this.type=e.type,this.details=e.details,this.name="AIServiceError"}}let i=null,a=!1;const l=()=>{i=null,a=!1};var c=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}l((s=s.apply(e,t||[])).next())}))};const u=t=>c(void 0,void 0,void 0,(function*(){let n=i;if(!n)try{const e=yield chrome.tabs.query({active:!0,currentWindow:!0});e.length>0&&e[0].id&&(n=e[0].id,(e=>{if(a)throw new Error("Another tab is currently generating content");i=e,a=!0})(n))}catch(t){if(t instanceof Error&&"Another tab is currently generating content"===t.message)return void d({type:e.GENERATION_IN_PROGRESS,message:"Please wait for the current generation to complete before starting a new one."});throw t}if(n)try{return yield chrome.tabs.sendMessage(n,t)}catch(e){console.error("Error sending message to tab:",e)}})),d=e=>{u({action:"ai_error",error:e})};function h(e){var t;return c(this,void 0,void 0,(function*(){const n=yield u({action:"ai_operation",operation:e});return null===(t=null==n?void 0:n.data)||void 0===t?void 0:t.id}))}var p=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}l((s=s.apply(e,t||[])).next())}))};var f=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}l((s=s.apply(e,t||[])).next())}))};const m={buffer:"",textContent:"",fullResponse:"",appliedOperations:new Map,currentOperations:new Map,isCodeBlock:!1,originalContent:[]};function y(e,t){return f(this,void 0,void 0,(function*(){m.buffer=m.buffer+e,m.fullResponse=m.fullResponse+e;const n=m.buffer.split(/\r?\n/);if(m.buffer=n.pop()||"",!m.isCodeBlock){const t=m.textContent+e;m.textContent=t,u({action:"ai_text_content",content:t})}var s;return yield function(e,t){var n,s,r;return p(this,void 0,void 0,(function*(){const o=/@CREATE\[type=(markdown|code),\s*position=(top|bottom|after:(cell-[^\]]+)|before:(cell-[^\]]+))\]/,i=/@EDIT\[(cell-[^\]]+)\]/,a=/@DELETE\[(cell-[^\]]+)\]/,l=/@END/,c=/@START_CODE/,u=/@END_CODE/;for(const d of t){if(d.match(c))return e.isCodeBlock=!0,e;if(d.match(u))return e.isCodeBlock=!1,e;const t=d.match(o),p=d.match(i),f=d.match(a);if(t){Date.now(),Math.random();const n={type:"create",cellType:t[1],cellId:"",position:t[2],contentArray:[],content:""};let s;if(n.position.startsWith("after:")){let t=n.position;const r=Array.from(e.appliedOperations.values()).filter((e=>"create"===e.type&&e.position===n.position));r.length>0&&(t=`after:${r[r.length-1].cellId}`),s=yield h(Object.assign(Object.assign({},n),{position:t}))}else s=yield h(n);if(!s||""===s)return console.log("[Parser] Failed to apply operation:",n),e;n.cellId=s,e.currentOperations.set(n.cellId,n),console.log("[Parser] Create operation:",n)}else if(p){const t=p[1],s={type:"edit",cellId:t,contentArray:[],content:"",originalContent:(null===(n=e.originalContent.find((e=>e.id===t)))||void 0===n?void 0:n.content)||""};e.currentOperations.set(t,s),yield h(s),console.log("[Parser] Edit operation:",s)}else if(f){const t=f[1],n=(null===(s=e.originalContent.find((e=>e.id===t)))||void 0===s?void 0:s.content)||"",r={type:"delete",cellId:t,originalContent:n};yield h(r),e.appliedOperations.set(t,Object.assign(Object.assign({},r),{pending:!0})),console.log("[Parser] Delete operation:",t)}else if(d.match(l)){for(const[t,n]of e.currentOperations.entries())if("create"===n.type||"edit"===n.type){console.log("[Parser] Applied operation:",n);const t=Object.assign(Object.assign({},n),{pending:!0});e.appliedOperations.set(n.cellId,t),yield h({type:"diff",cellId:n.cellId,originalContent:"edit"===n.type?n.originalContent:"",content:n.content})}e.currentOperations.clear()}else for(const t of e.currentOperations.values())"delete"!==t.type&&"contentArray"in t&&t.contentArray&&(null===(r=t.contentArray)||void 0===r||r.push(d),t.content=t.contentArray.join("\n"),yield h({type:"edit",cellId:t.cellId,contentArray:t.contentArray,content:t.content,originalContent:"edit"===t.type?t.originalContent:""}))}return e}))}(m,n),t&&(s=m.appliedOperations,u({action:"ai_done_generating",pendingOperations:[...s.entries()]})),m}))}const g="4.69.0";let w,b,_,v,E,S,x,A,I,O=!1,P=null,C=null,k=null,R=null;class T{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}w||function(e,t={auto:!1}){if(O)throw new Error(`you must \`import 'openai/shims/${e.kind}'\` before importing anything else from openai`);if(w)throw new Error(`can't \`import 'openai/shims/${e.kind}'\` after \`import 'openai/shims/${w}'\``);O=t.auto,w=e.kind,b=e.fetch,P=e.Request,C=e.Response,k=e.Headers,_=e.FormData,R=e.Blob,v=e.File,E=e.ReadableStream,S=e.getMultipartRequestOptions,x=e.getDefaultAgent,A=e.fileFromPath,I=e.isFsReadStream}(function({manuallyImported:e}={}){const t=e?"You may need to use polyfills":"Add one of these imports before your first `import â€¦ from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let n,s,r,o;try{n=fetch,s=Request,r=Response,o=Headers}catch(e){throw new Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${t}`)}return{kind:"web",fetch:n,Request:s,Response:r,Headers:o,FormData:"undefined"!=typeof FormData?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${t}`)}},Blob:"undefined"!=typeof Blob?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${t}`)}},File:"undefined"!=typeof File?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${t}`)}},ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${t}`)}},getMultipartRequestOptions:async(e,t)=>({...t,body:new T(e)}),getDefaultAgent:e=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:e=>!1}}(),{auto:!0});class D{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const n=D.NEWLINE_CHARS.has(t[t.length-1]||"");let s=t.split(D.NEWLINE_REGEXP);return n&&s.pop(),1!==s.length||n?(this.buffer.length>0&&(s=[this.buffer.join("")+s[0],...s.slice(1)],this.buffer=[]),n||(this.buffer=[s.pop()||""]),s):(this.buffer.push(s[0]),[])}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if("undefined"!=typeof Buffer){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new Ie(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("undefined"!=typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new Ie(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new Ie("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}D.NEWLINE_CHARS=new Set(["\n","\r"]),D.NEWLINE_REGEXP=/\r\n|[\n\r]/g;class N{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;return new N((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let s=!1;try{for await(const n of async function*(e,t){if(!e.body)throw t.abort(),new Ie("Attempted to iterate over a response with no body");const n=new M,s=new D,r=j(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?(new TextEncoder).encode(n):n;let s,r=new Uint8Array(t.length+e.length);for(r.set(t),r.set(e,t.length),t=r;-1!==(s=$(t));)yield t.slice(0,s),t=t.slice(s)}t.length>0&&(yield t)}(r))for(const t of s.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of s.flush()){const t=n.decode(e);t&&(yield t)}}(e,t))if(!s)if(n.data.startsWith("[DONE]"))s=!0;else if(null===n.event){let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if(e&&e.error)throw new Oe(void 0,e.error,void 0,void 0);yield e}else{let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if("error"==n.event)throw new Oe(void 0,e.error,e.message,void 0);yield{event:n.event,data:e}}s=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{s||t.abort()}}),t)}static fromReadableStream(e,t){let n=!1;return new N((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let s=!1;try{for await(const t of async function*(){const t=new D,n=j(e);for await(const e of n)for(const n of t.decode(e))yield n;for(const e of t.flush())yield e}())s||t&&(yield JSON.parse(t));s=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{s||t.abort()}}),t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),s=s=>({next:()=>{if(0===s.length){const s=n.next();e.push(s),t.push(s)}return s.shift()}});return[new N((()=>s(e)),this.controller),new N((()=>s(t)),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new E({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:s,done:r}=await t.next();if(r)return e.close();const o=n.encode(JSON.stringify(s)+"\n");e.enqueue(o)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}function $(e){for(let t=0;t<e.length-2;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}class M{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,s]=function(e,t){const n=e.indexOf(t);if(-1!==n)return[e.substring(0,n),t,e.substring(n+t.length)];return[e,"",""]}(e,":");return s.startsWith(" ")&&(s=s.substring(1)),"event"===t?this.event=s:"data"===t&&this.data.push(s),null}}function j(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const q=e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob,B=e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&F(e),F=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer,L=e=>B(e)||q(e)||I(e);async function U(e,t,n){if(e=await e,B(e))return e;if(q(e)){const s=await e.blob();t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file");const r=F(s)?[await s.arrayBuffer()]:[s];return new v(r,t,n)}const s=await async function(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(F(e))t.push(await e.arrayBuffer());else{if(!X(e))throw new Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${function(e){const t=Object.getOwnPropertyNames(e);return`[${t.map((e=>`"${e}"`)).join(", ")}]`}(e)}`);for await(const n of e)t.push(n)}return t}(e);if(t||(t=function(e){return W(e.name)||W(e.filename)||W(e.path)?.split(/[\\/]/).pop()}(e)??"unknown_file"),!n?.type){const e=s[0]?.type;"string"==typeof e&&(n={...n,type:e})}return new v(s,t,n)}const W=e=>"string"==typeof e?e:"undefined"!=typeof Buffer&&e instanceof Buffer?String(e):void 0,X=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],J=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag],H=async e=>{const t=await V(e.body);return S(t,e)},V=async e=>{const t=new _;return await Promise.all(Object.entries(e||{}).map((([e,n])=>K(t,e,n)))),t},K=async(e,t,n)=>{if(void 0!==n){if(null==n)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof n||"number"==typeof n||"boolean"==typeof n)e.append(t,String(n));else if(L(n)){const s=await U(n);e.append(t,s)}else if(Array.isArray(n))await Promise.all(n.map((n=>K(e,t+"[]",n))));else{if("object"!=typeof n)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`);await Promise.all(Object.entries(n).map((([n,s])=>K(e,`${t}[${n}]`,s))))}}};var z,G=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n},Q=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)};async function Y(e){const{response:t}=e;if(e.options.stream)return Ee("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):N.fromSSEResponse(t,e.controller);if(204===t.status)return null;if(e.options.__binaryResponse)return t;const n=t.headers.get("content-type");if(n?.includes("application/json")||n?.includes("application/vnd.api+json")){const e=await t.json();return Ee("response",t.status,t.url,t.headers,e),Z(e,t)}const s=await t.text();return Ee("response",t.status,t.url,t.headers,s),s}function Z(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}class ee extends Promise{constructor(e,t=Y){super((e=>{e(null)})),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new ee(this.responsePromise,(async t=>Z(e(await this.parseResponse(t),t),t.response)))}asResponse(){return this.responsePromise.then((e=>e.response))}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class te{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:s,fetch:r}){this.baseURL=e,this.maxRetries=ye("maxRetries",t),this.timeout=ye("timeout",n),this.httpAgent=s,this.fetch=r??b}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...de(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Se()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then((async n=>{const s=n&&F(n?.body)?new DataView(await n.body.arrayBuffer()):n?.body instanceof DataView?n.body:n?.body instanceof ArrayBuffer?new DataView(n.body):n&&ArrayBuffer.isView(n?.body)?new DataView(n.body.buffer):n?.body;return{method:e,path:t,...n,body:s}})))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if("string"==typeof e){if("undefined"!=typeof Buffer)return Buffer.byteLength(e,"utf8").toString();if("undefined"!=typeof TextEncoder){return(new TextEncoder).encode(e).length.toString()}}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){const{method:n,path:s,query:r,headers:o={}}=e,i=ArrayBuffer.isView(e.body)||e.__binaryRequest&&"string"==typeof e.body?e.body:J(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,a=this.calculateContentLength(i),l=this.buildURL(s,r);"timeout"in e&&ye("timeout",e.timeout);const c=e.timeout??this.timeout,u=e.httpAgent??this.httpAgent??x(l),d=c+1e3;"number"==typeof u?.options?.timeout&&d>(u.options.timeout??0)&&(u.options.timeout=d),this.idempotencyHeader&&"get"!==n&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),o[this.idempotencyHeader]=e.idempotencyKey);return{req:{method:n,...i&&{body:i},headers:this.buildHeaders({options:e,headers:o,contentLength:a,retryCount:t}),...u&&{agent:u},signal:e.signal??null},url:l,timeout:c}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:s}){const r={};n&&(r["content-length"]=n);const o=this.defaultHeaders(e);return ve(r,o),ve(r,t),J(e.body)&&"node"!==w&&delete r["content-type"],void 0===xe(o,"x-stainless-retry-count")&&void 0===xe(t,"x-stainless-retry-count")&&(r["x-stainless-retry-count"]=String(s)),this.validateHeaders(r,t),r}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map((e=>[...e]))):{...e}:{}}makeStatusError(e,t,n,s){return Oe.generate(e,t,n,s)}request(e,t=null){return new ee(this.makeRequest(e,t))}async makeRequest(e,t){const n=await e,s=n.maxRetries??this.maxRetries;null==t&&(t=s),await this.prepareOptions(n);const{req:r,url:o,timeout:i}=this.buildRequest(n,{retryCount:s-t});if(await this.prepareRequest(r,{url:o,options:n}),Ee("request",o,n,r.headers),n.signal?.aborted)throw new Pe;const a=new AbortController,l=await this.fetchWithTimeout(o,r,i,a).catch(ge);if(l instanceof Error){if(n.signal?.aborted)throw new Pe;if(t)return this.retryRequest(n,t);if("AbortError"===l.name)throw new ke;throw new Ce({cause:l})}const c=re(l.headers);if(!l.ok){if(t&&this.shouldRetry(l)){return Ee(`response (error; ${`retrying, ${t} attempts remaining`})`,l.status,o,c),this.retryRequest(n,t,c)}const e=await l.text().catch((e=>ge(e).message)),s=he(e),r=s?void 0:e;Ee(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,l.status,o,c,r);throw this.makeStatusError(l.status,s,r,c)}return{response:l,options:n,controller:a}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new se(this,n,e)}buildURL(e,t){const n=fe(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return be(s)||(t={...s,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter((([e,t])=>void 0!==t)).map((([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new Ie(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)})).join("&")}async fetchWithTimeout(e,t,n,s){const{signal:r,...o}=t||{};r&&r.addEventListener("abort",(()=>s.abort()));const i=setTimeout((()=>s.abort()),n);return this.getRequestClient().fetch.call(void 0,e,{signal:s.signal,...o}).finally((()=>{clearTimeout(i)}))}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||(409===e.status||(429===e.status||e.status>=500)))}async retryRequest(e,t,n){let s;const r=n?.["retry-after-ms"];if(r){const e=parseFloat(r);Number.isNaN(e)||(s=e)}const o=n?.["retry-after"];if(o&&!s){const e=parseFloat(o);s=Number.isNaN(e)?Date.parse(o)-Date.now():1e3*e}if(!(s&&0<=s&&s<6e4)){const n=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,n)}return await me(s),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${g}`}}class ne{constructor(e,t,n,s){z.set(this,void 0),G(this,z,e,"f"),this.options=s,this.response=t,this.body=n}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageInfo()}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new Ie("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&"object"==typeof t.query)t.query={...t.query,...e.params};else if("url"in e){const n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[t,s]of n)e.url.searchParams.set(t,s);t.query=void 0,t.path=e.url.toString()}return await Q(this,z,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(z=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class se extends ee{constructor(e,t,n){super(t,(async t=>new n(e,t.response,await Y(t),t.options)))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}const re=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),oe={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},ie=e=>"object"==typeof e&&null!==e&&!be(e)&&Object.keys(e).every((e=>_e(oe,e))),ae=()=>{if("undefined"!=typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":g,"X-Stainless-OS":ce(Deno.build.os),"X-Stainless-Arch":le(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":g,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":g,"X-Stainless-OS":ce(process.platform),"X-Stainless-Arch":le(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const e=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e){return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}}return null}();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":g,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":g,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};const le=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",ce=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let ue;const de=()=>ue??(ue=ae()),he=e=>{try{return JSON.parse(e)}catch(e){return}},pe=new RegExp("^(?:[a-z]+:)?//","i"),fe=e=>pe.test(e),me=e=>new Promise((t=>setTimeout(t,e))),ye=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new Ie(`${e} must be an integer`);if(t<0)throw new Ie(`${e} must be a positive integer`);return t},ge=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e)try{return new Error(JSON.stringify(e))}catch{}return new Error(e)},we=e=>"undefined"!=typeof process?process.env?.[e]?.trim()??void 0:"undefined"!=typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function be(e){if(!e)return!0;for(const t in e)return!1;return!0}function _e(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function ve(e,t){for(const n in t){if(!_e(t,n))continue;const s=n.toLowerCase();if(!s)continue;const r=t[n];null===r?delete e[s]:void 0!==r&&(e[s]=r)}}function Ee(e,...t){"undefined"!=typeof process&&"true"===process?.env?.DEBUG&&console.log(`OpenAI:DEBUG:${e}`,...t)}const Se=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),xe=(e,t)=>{const n=t.toLowerCase();if((e=>"function"==typeof e?.get)(e)){const s=t[0]?.toUpperCase()+t.substring(1).replace(/([^\w])(\w)/g,((e,t,n)=>t+n.toUpperCase()));for(const r of[t,n,t.toUpperCase(),s]){const t=e.get(r);if(t)return t}}for(const[s,r]of Object.entries(e))if(s.toLowerCase()===n)return Array.isArray(r)?(r.length<=1||console.warn(`Received ${r.length} entries for the ${t} header, using the first entry.`),r[0]):r};function Ae(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}class Ie extends Error{}class Oe extends Ie{constructor(e,t,n,s){super(`${Oe.makeMessage(e,t,n)}`),this.status=e,this.headers=s,this.request_id=s?.["x-request-id"];const r=t;this.error=r,this.code=r?.code,this.param=r?.param,this.type=r?.type}static makeMessage(e,t,n){const s=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,n,s){if(!e)return new Ce({message:n,cause:ge(t)});const r=t?.error;return 400===e?new Re(e,r,n,s):401===e?new Te(e,r,n,s):403===e?new De(e,r,n,s):404===e?new Ne(e,r,n,s):409===e?new $e(e,r,n,s):422===e?new Me(e,r,n,s):429===e?new je(e,r,n,s):e>=500?new qe(e,r,n,s):new Oe(e,r,n,s)}}class Pe extends Oe{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}}class Ce extends Oe{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}}class ke extends Ce{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Re extends Oe{constructor(){super(...arguments),this.status=400}}class Te extends Oe{constructor(){super(...arguments),this.status=401}}class De extends Oe{constructor(){super(...arguments),this.status=403}}class Ne extends Oe{constructor(){super(...arguments),this.status=404}}class $e extends Oe{constructor(){super(...arguments),this.status=409}}class Me extends Oe{constructor(){super(...arguments),this.status=422}}class je extends Oe{constructor(){super(...arguments),this.status=429}}class qe extends Oe{}class Be extends Ie{constructor(){super("Could not parse response content as the length limit was reached")}}class Fe extends Ie{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}const Le="RFC3986",Ue={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:e=>String(e)},We=(Object.prototype.hasOwnProperty,Array.isArray),Xe=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})();const Je=1024;function He(e,t){if(We(e)){const n=[];for(let s=0;s<e.length;s+=1)n.push(t(e[s]));return n}return t(e)}const Ve=Object.prototype.hasOwnProperty,Ke={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},ze=Array.isArray,Ge=Array.prototype.push,Qe=function(e,t){Ge.apply(e,ze(t)?t:[t])},Ye=Date.prototype.toISOString,Ze={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,n,s,r)=>{if(0===e.length)return e;let o=e;if("symbol"==typeof e?o=Symbol.prototype.toString.call(e):"string"!=typeof e&&(o=String(e)),"iso-8859-1"===n)return escape(o).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));let i="";for(let e=0;e<o.length;e+=Je){const t=o.length>=Je?o.slice(e,e+Je):o,n=[];for(let e=0;e<t.length;++e){let s=t.charCodeAt(e);45===s||46===s||95===s||126===s||s>=48&&s<=57||s>=65&&s<=90||s>=97&&s<=122||"RFC1738"===r&&(40===s||41===s)?n[n.length]=t.charAt(e):s<128?n[n.length]=Xe[s]:s<2048?n[n.length]=Xe[192|s>>6]+Xe[128|63&s]:s<55296||s>=57344?n[n.length]=Xe[224|s>>12]+Xe[128|s>>6&63]+Xe[128|63&s]:(e+=1,s=65536+((1023&s)<<10|1023&t.charCodeAt(e)),n[n.length]=Xe[240|s>>18]+Xe[128|s>>12&63]+Xe[128|s>>6&63]+Xe[128|63&s])}i+=n.join("")}return i},encodeValuesOnly:!1,format:Le,formatter:Ue[Le],indices:!1,serializeDate:e=>Ye.call(e),skipNulls:!1,strictNullHandling:!1};const et={};function tt(e,t,n,s,r,o,i,a,l,c,u,d,h,p,f,m,y,g){let w=e,b=g,_=0,v=!1;for(;void 0!==(b=b.get(et))&&!v;){const t=b.get(e);if(_+=1,void 0!==t){if(t===_)throw new RangeError("Cyclic object value");v=!0}void 0===b.get(et)&&(_=0)}if("function"==typeof c?w=c(t,w):w instanceof Date?w=h?.(w):"comma"===n&&ze(w)&&(w=He(w,(function(e){return e instanceof Date?h?.(e):e}))),null===w){if(o)return l&&!m?l(t,Ze.encoder,y,"key",p):t;w=""}if("string"==typeof(E=w)||"number"==typeof E||"boolean"==typeof E||"symbol"==typeof E||"bigint"==typeof E||function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))}(w)){if(l){const e=m?t:l(t,Ze.encoder,y,"key",p);return[f?.(e)+"="+f?.(l(w,Ze.encoder,y,"value",p))]}return[f?.(t)+"="+f?.(String(w))]}var E;const S=[];if(void 0===w)return S;let x;if("comma"===n&&ze(w))m&&l&&(w=He(w,l)),x=[{value:w.length>0?w.join(",")||null:void 0}];else if(ze(c))x=c;else{const e=Object.keys(w);x=u?e.sort(u):e}const A=a?String(t).replace(/\./g,"%2E"):String(t),I=s&&ze(w)&&1===w.length?A+"[]":A;if(r&&ze(w)&&0===w.length)return I+"[]";for(let t=0;t<x.length;++t){const b=x[t],v="object"==typeof b&&void 0!==b.value?b.value:w[b];if(i&&null===v)continue;const E=d&&a?b.replace(/\./g,"%2E"):b,A=ze(w)?"function"==typeof n?n(I,E):I:I+(d?"."+E:"["+E+"]");g.set(e,_);const O=new WeakMap;O.set(et,g),Qe(S,tt(v,A,n,s,r,o,i,a,"comma"===n&&m&&ze(w)?null:l,c,u,d,h,p,f,m,y,O))}return S}function nt(e,t={}){let n=e;const s=function(e=Ze){if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");const t=e.charset||Ze.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=Le;if(void 0!==e.format){if(!Ve.call(Ue,e.format))throw new TypeError("Unknown format option provided.");n=e.format}const s=Ue[n];let r,o=Ze.filter;if(("function"==typeof e.filter||ze(e.filter))&&(o=e.filter),r=e.arrayFormat&&e.arrayFormat in Ke?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":Ze.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=void 0===e.allowDots?1==!!e.encodeDotInKeys||Ze.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:Ze.addQueryPrefix,allowDots:i,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:Ze.allowEmptyArrays,arrayFormat:r,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:Ze.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?Ze.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:Ze.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:Ze.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:Ze.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:Ze.encodeValuesOnly,filter:o,format:n,formatter:s,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:Ze.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:Ze.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:Ze.strictNullHandling}}(t);let r,o;"function"==typeof s.filter?(o=s.filter,n=o("",n)):ze(s.filter)&&(o=s.filter,r=o);const i=[];if("object"!=typeof n||null===n)return"";const a=Ke[s.arrayFormat],l="comma"===a&&s.commaRoundTrip;r||(r=Object.keys(n)),s.sort&&r.sort(s.sort);const c=new WeakMap;for(let e=0;e<r.length;++e){const t=r[e];s.skipNulls&&null===n[t]||Qe(i,tt(n[t],t,a,l,s.allowEmptyArrays,s.strictNullHandling,s.skipNulls,s.encodeDotInKeys,s.encode?s.encoder:null,s.filter,s.sort,s.allowDots,s.serializeDate,s.format,s.formatter,s.encodeValuesOnly,s.charset,c))}const u=i.join(s.delimiter);let d=!0===s.addQueryPrefix?"?":"";return s.charsetSentinel&&("iso-8859-1"===s.charset?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),u.length>0?d+u:""}class st extends ne{constructor(e,t,n,s){super(e,t,n,s),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class rt extends ne{constructor(e,t,n,s){super(e,t,n,s),this.data=n.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){const e=this.getPaginatedItems();if(!e.length)return null;const t=e[e.length-1]?.id;return t?{params:{after:t}}:null}}class ot{constructor(e){this._client=e}}class it extends ot{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}it||(it={});class at extends ot{create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}}at||(at={});class lt extends ot{constructor(){super(...arguments),this.completions=new at(this._client)}}!function(e){e.Completions=at}(lt||(lt={}));class ct extends ot{create(e,t){return this._client.post("/embeddings",{body:e,...t})}}ct||(ct={});class ut extends ot{create(e,t){return this._client.post("/files",H({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/files",dt,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t?.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=18e5}={}){const s=new Set(["processed","error","deleted"]),r=Date.now();let o=await this.retrieve(e);for(;!o.status||!s.has(o.status);)if(await me(t),o=await this.retrieve(e),Date.now()-r>n)throw new ke({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return o}}class dt extends st{}!function(e){e.FileObjectsPage=dt}(ut||(ut={}));class ht extends ot{createVariation(e,t){return this._client.post("/images/variations",H({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",H({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}ht||(ht={});class pt extends ot{create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}}pt||(pt={});class ft extends ot{create(e,t){return this._client.post("/audio/transcriptions",H({body:e,...t}))}}ft||(ft={});class mt extends ot{create(e,t){return this._client.post("/audio/translations",H({body:e,...t}))}}mt||(mt={});class yt extends ot{constructor(){super(...arguments),this.transcriptions=new ft(this._client),this.translations=new mt(this._client),this.speech=new pt(this._client)}}!function(e){e.Transcriptions=ft,e.Translations=mt,e.Speech=pt}(yt||(yt={}));class gt extends ot{create(e,t){return this._client.post("/moderations",{body:e,...t})}}gt||(gt={});class wt extends ot{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",bt,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class bt extends st{}!function(e){e.ModelsPage=bt}(wt||(wt={}));class _t extends ot{list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,vt,{query:t,...n})}}class vt extends rt{}!function(e){e.FineTuningJobCheckpointsPage=vt}(_t||(_t={}));class Et extends ot{constructor(){super(...arguments),this.checkpoints=new _t(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",St,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return ie(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,xt,{query:t,...n})}}class St extends rt{}class xt extends rt{}!function(e){e.FineTuningJobsPage=St,e.FineTuningJobEventsPage=xt,e.Checkpoints=_t,e.FineTuningJobCheckpointsPage=vt}(Et||(Et={}));class At extends ot{constructor(){super(...arguments),this.jobs=new Et(this._client)}}!function(e){e.Jobs=Et,e.FineTuningJobsPage=St,e.FineTuningJobEventsPage=xt}(At||(At={}));class It extends ot{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/assistants/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/assistants",Ot,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Ot extends rt{}function Pt(e){return"function"==typeof e.parse}!function(e){e.AssistantsPage=Ot}(It||(It={}));const Ct=e=>"assistant"===e?.role,kt=e=>"function"===e?.role,Rt=e=>"tool"===e?.role;var Tt,Dt,Nt,$t,Mt,jt,qt,Bt,Ft,Lt,Ut,Wt,Xt,Jt=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n},Ht=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)};class Vt{constructor(){Tt.add(this),this.controller=new AbortController,Dt.set(this,void 0),Nt.set(this,(()=>{})),$t.set(this,(()=>{})),Mt.set(this,void 0),jt.set(this,(()=>{})),qt.set(this,(()=>{})),Bt.set(this,{}),Ft.set(this,!1),Lt.set(this,!1),Ut.set(this,!1),Wt.set(this,!1),Jt(this,Dt,new Promise(((e,t)=>{Jt(this,Nt,e,"f"),Jt(this,$t,t,"f")})),"f"),Jt(this,Mt,new Promise(((e,t)=>{Jt(this,jt,e,"f"),Jt(this,qt,t,"f")})),"f"),Ht(this,Dt,"f").catch((()=>{})),Ht(this,Mt,"f").catch((()=>{}))}_run(e){setTimeout((()=>{e().then((()=>{this._emitFinal(),this._emit("end")}),Ht(this,Tt,"m",Xt).bind(this))}),0)}_connected(){this.ended||(Ht(this,Nt,"f").call(this),this._emit("connect"))}get ended(){return Ht(this,Ft,"f")}get errored(){return Ht(this,Lt,"f")}get aborted(){return Ht(this,Ut,"f")}abort(){this.controller.abort()}on(e,t){return(Ht(this,Bt,"f")[e]||(Ht(this,Bt,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=Ht(this,Bt,"f")[e];if(!n)return this;const s=n.findIndex((e=>e.listener===t));return s>=0&&n.splice(s,1),this}once(e,t){return(Ht(this,Bt,"f")[e]||(Ht(this,Bt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise(((t,n)=>{Jt(this,Wt,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)}))}async done(){Jt(this,Wt,!0,"f"),await Ht(this,Mt,"f")}_emit(e,...t){if(Ht(this,Ft,"f"))return;"end"===e&&(Jt(this,Ft,!0,"f"),Ht(this,jt,"f").call(this));const n=Ht(this,Bt,"f")[e];if(n&&(Ht(this,Bt,"f")[e]=n.filter((e=>!e.once)),n.forEach((({listener:e})=>e(...t)))),"abort"===e){const e=t[0];return Ht(this,Wt,"f")||n?.length||Promise.reject(e),Ht(this,$t,"f").call(this,e),Ht(this,qt,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];Ht(this,Wt,"f")||n?.length||Promise.reject(e),Ht(this,$t,"f").call(this,e),Ht(this,qt,"f").call(this,e),this._emit("end")}}_emitFinal(){}}function Kt(e){return"auto-parseable-response-format"===e?.$brand}function zt(e){return"auto-parseable-tool"===e?.$brand}function Gt(e,t){const n=e.choices.map((e=>{if("length"===e.finish_reason)throw new Be;if("content_filter"===e.finish_reason)throw new Fe;return{...e,message:{...e.message,tool_calls:e.message.tool_calls?.map((e=>function(e,t){const n=e.tools?.find((e=>e.function?.name===t.function.name));return{...t,function:{...t.function,parsed_arguments:zt(n)?n.$parseRaw(t.function.arguments):n?.function.strict?JSON.parse(t.function.arguments):null}}}(t,e)))??[],parsed:e.message.content&&!e.message.refusal?Qt(t,e.message.content):null}}}));return{...e,choices:n}}function Qt(e,t){if("json_schema"!==e.response_format?.type)return null;if("json_schema"===e.response_format?.type){if("$parseRaw"in e.response_format){return e.response_format.$parseRaw(t)}return JSON.parse(t)}return null}function Yt(e,t){if(!e)return!1;const n=e.tools?.find((e=>e.function?.name===t.function.name));return zt(n)||n?.function.strict||!1}function Zt(e){return!!Kt(e.response_format)||(e.tools?.some((e=>zt(e)||"function"===e.type&&!0===e.function.strict))??!1)}Dt=new WeakMap,Nt=new WeakMap,$t=new WeakMap,Mt=new WeakMap,jt=new WeakMap,qt=new WeakMap,Bt=new WeakMap,Ft=new WeakMap,Lt=new WeakMap,Ut=new WeakMap,Wt=new WeakMap,Tt=new WeakSet,Xt=function(e){if(Jt(this,Lt,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new Pe),e instanceof Pe)return Jt(this,Ut,!0,"f"),this._emit("abort",e);if(e instanceof Ie)return this._emit("error",e);if(e instanceof Error){const t=new Ie(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new Ie(String(e)))};var en,tn,nn,sn,rn,on,an,ln,cn=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)};const un=10;class dn extends Vt{constructor(){super(...arguments),en.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),(kt(e)||Rt(e))&&e.content)this._emit("functionCallResult",e.content);else if(Ct(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Ct(e)&&e.tool_calls)for(const t of e.tool_calls)"function"===t.type&&this._emit("functionCall",t.function)}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new Ie("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),cn(this,en,"m",tn).call(this)}async finalMessage(){return await this.done(),cn(this,en,"m",nn).call(this)}async finalFunctionCall(){return await this.done(),cn(this,en,"m",sn).call(this)}async finalFunctionCallResult(){return await this.done(),cn(this,en,"m",rn).call(this)}async totalUsage(){return await this.done(),cn(this,en,"m",on).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=cn(this,en,"m",nn).call(this);t&&this._emit("finalMessage",t);const n=cn(this,en,"m",tn).call(this);n&&this._emit("finalContent",n);const s=cn(this,en,"m",sn).call(this);s&&this._emit("finalFunctionCall",s);const r=cn(this,en,"m",rn).call(this);null!=r&&this._emit("finalFunctionCallResult",r),this._chatCompletions.some((e=>e.usage))&&this._emit("totalUsage",cn(this,en,"m",on).call(this))}async _createChatCompletion(e,t,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",(()=>this.controller.abort()))),cn(this,en,"m",an).call(this,t);const r=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Gt(r,t))}async _runChatCompletion(e,t,n){for(const e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,n)}async _runFunctions(e,t,n){const s="function",{function_call:r="auto",stream:o,...i}=t,a="string"!=typeof r&&r?.name,{maxChatCompletions:l=un}=n||{},c={};for(const e of t.functions)c[e.name||e.function.name]=e;const u=t.functions.map((e=>({name:e.name||e.function.name,parameters:e.parameters,description:e.description})));for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){const t=await this._createChatCompletion(e,{...i,function_call:r,functions:u,messages:[...this.messages]},n),o=t.choices[0]?.message;if(!o)throw new Ie("missing message in ChatCompletion response");if(!o.function_call)return;const{name:l,arguments:d}=o.function_call,h=c[l];if(!h){const e=`Invalid function_call: ${JSON.stringify(l)}. Available options are: ${u.map((e=>JSON.stringify(e.name))).join(", ")}. Please try again`;this._addMessage({role:s,name:l,content:e});continue}if(a&&a!==l){const e=`Invalid function_call: ${JSON.stringify(l)}. ${JSON.stringify(a)} requested. Please try again`;this._addMessage({role:s,name:l,content:e});continue}let p;try{p=Pt(h)?await h.parse(d):d}catch(e){this._addMessage({role:s,name:l,content:e instanceof Error?e.message:String(e)});continue}const f=await h.function(p,this),m=cn(this,en,"m",ln).call(this,f);if(this._addMessage({role:s,name:l,content:m}),a)return}}async _runTools(e,t,n){const s="tool",{tool_choice:r="auto",stream:o,...i}=t,a="string"!=typeof r&&r?.function?.name,{maxChatCompletions:l=un}=n||{},c=t.tools.map((e=>{if(zt(e)){if(!e.$callback)throw new Ie("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e})),u={};for(const e of c)"function"===e.type&&(u[e.function.name||e.function.function.name]=e.function);const d="tools"in t?c.map((e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e)):void 0;for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){const t=await this._createChatCompletion(e,{...i,tool_choice:r,tools:d,messages:[...this.messages]},n),o=t.choices[0]?.message;if(!o)throw new Ie("missing message in ChatCompletion response");if(!o.tool_calls?.length)return;for(const e of o.tool_calls){if("function"!==e.type)continue;const t=e.id,{name:n,arguments:r}=e.function,o=u[n];if(!o){const e=`Invalid tool_call: ${JSON.stringify(n)}. Available options are: ${Object.keys(u).map((e=>JSON.stringify(e))).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:t,content:e});continue}if(a&&a!==n){const e=`Invalid tool_call: ${JSON.stringify(n)}. ${JSON.stringify(a)} requested. Please try again`;this._addMessage({role:s,tool_call_id:t,content:e});continue}let i;try{i=Pt(o)?await o.parse(r):r}catch(e){const n=e instanceof Error?e.message:String(e);this._addMessage({role:s,tool_call_id:t,content:n});continue}const l=await o.function(i,this),c=cn(this,en,"m",ln).call(this,l);if(this._addMessage({role:s,tool_call_id:t,content:c}),a)return}}}}en=new WeakSet,tn=function(){return cn(this,en,"m",nn).call(this).content??null},nn=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(Ct(t)){const{function_call:e,...n}=t,s={...n,content:t.content??null,refusal:t.refusal??null};return e&&(s.function_call=e),s}}throw new Ie("stream ended without producing a ChatCompletionMessage with role=assistant")},sn=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Ct(t)&&t?.function_call)return t.function_call;if(Ct(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},rn=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(kt(t)&&null!=t.content)return t.content;if(Rt(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some((e=>"assistant"===e.role&&e.tool_calls?.some((e=>"function"===e.type&&e.id===t.tool_call_id)))))return t.content}},on=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},an=function(e){if(null!=e.n&&e.n>1)throw new Ie("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},ln=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class hn extends dn{static runFunctions(e,t,n){const s=new hn,r={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run((()=>s._runFunctions(e,t,r))),s}static runTools(e,t,n){const s=new hn,r={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run((()=>s._runTools(e,t,r))),s}_addMessage(e,t=!0){super._addMessage(e,t),Ct(e)&&e.content&&this._emit("content",e.content)}}const pn=1,fn=2,mn=4,yn=8,gn=16,wn=32,bn=64,_n=128,vn=256,En=511;class Sn extends Error{}class xn extends Error{}const An=(e,t)=>{const n=e.length;let s=0;const r=e=>{throw new Sn(`${e} at position ${s}`)},o=e=>{throw new xn(`${e} at position ${s}`)},i=()=>(d(),s>=n&&r("Unexpected end of input"),'"'===e[s]?a():"{"===e[s]?l():"["===e[s]?c():"null"===e.substring(s,s+4)||gn&t&&n-s<4&&"null".startsWith(e.substring(s))?(s+=4,null):"true"===e.substring(s,s+4)||wn&t&&n-s<4&&"true".startsWith(e.substring(s))?(s+=4,!0):"false"===e.substring(s,s+5)||wn&t&&n-s<5&&"false".startsWith(e.substring(s))?(s+=5,!1):"Infinity"===e.substring(s,s+8)||_n&t&&n-s<8&&"Infinity".startsWith(e.substring(s))?(s+=8,1/0):"-Infinity"===e.substring(s,s+9)||vn&t&&1<n-s&&n-s<9&&"-Infinity".startsWith(e.substring(s))?(s+=9,-1/0):"NaN"===e.substring(s,s+3)||bn&t&&n-s<3&&"NaN".startsWith(e.substring(s))?(s+=3,NaN):u()),a=()=>{const i=s;let a=!1;for(s++;s<n&&('"'!==e[s]||a&&"\\"===e[s-1]);)a="\\"===e[s]&&!a,s++;if('"'==e.charAt(s))try{return JSON.parse(e.substring(i,++s-Number(a)))}catch(e){o(String(e))}else if(pn&t)try{return JSON.parse(e.substring(i,s-Number(a))+'"')}catch(t){return JSON.parse(e.substring(i,e.lastIndexOf("\\"))+'"')}r("Unterminated string literal")},l=()=>{s++,d();const o={};try{for(;"}"!==e[s];){if(d(),s>=n&&yn&t)return o;const r=a();d(),s++;try{const e=i();Object.defineProperty(o,r,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(yn&t)return o;throw e}d(),","===e[s]&&s++}}catch(e){if(yn&t)return o;r("Expected '}' at end of object")}return s++,o},c=()=>{s++;const n=[];try{for(;"]"!==e[s];)n.push(i()),d(),","===e[s]&&s++}catch(e){if(mn&t)return n;r("Expected ']' at end of array")}return s++,n},u=()=>{if(0===s){"-"===e&&fn&t&&r("Not sure what '-' is");try{return JSON.parse(e)}catch(n){if(fn&t)try{return"."===e[e.length-1]?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}o(String(n))}}const i=s;for("-"===e[s]&&s++;e[s]&&!",]}".includes(e[s]);)s++;s!=n||fn&t||r("Unterminated number literal");try{return JSON.parse(e.substring(i,s))}catch(n){"-"===e.substring(i,s)&&fn&t&&r("Not sure what '-' is");try{return JSON.parse(e.substring(i,e.lastIndexOf("e")))}catch(e){o(String(e))}}},d=()=>{for(;s<n&&" \n\r\t".includes(e[s]);)s++};return i()},In=e=>function(e,t=En){if("string"!=typeof e)throw new TypeError("expecting str, got "+typeof e);if(!e.trim())throw new Error(`${e} is empty`);return An(e.trim(),t)}(e,En^fn);var On,Pn,Cn,kn,Rn,Tn,Dn,Nn,$n,Mn,jn,qn,Bn=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n},Fn=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)};class Ln extends dn{constructor(e){super(),On.add(this),Pn.set(this,void 0),Cn.set(this,void 0),kn.set(this,void 0),Bn(this,Pn,e,"f"),Bn(this,Cn,[],"f")}get currentChatCompletionSnapshot(){return Fn(this,kn,"f")}static fromReadableStream(e){const t=new Ln(null);return t._run((()=>t._fromReadableStream(e))),t}static createChatCompletion(e,t,n){const s=new Ln(t);return s._run((()=>s._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),s}async _createChatCompletion(e,t,n){super._createChatCompletion;const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",(()=>this.controller.abort()))),Fn(this,On,"m",Rn).call(this);const r=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of r)Fn(this,On,"m",Dn).call(this,e);if(r.controller.signal?.aborted)throw new Pe;return this._addChatCompletion(Fn(this,On,"m",Mn).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),Fn(this,On,"m",Rn).call(this),this._connected();const s=N.fromReadableStream(e,this.controller);let r;for await(const e of s)r&&r!==e.id&&this._addChatCompletion(Fn(this,On,"m",Mn).call(this)),Fn(this,On,"m",Dn).call(this,e),r=e.id;if(s.controller.signal?.aborted)throw new Pe;return this._addChatCompletion(Fn(this,On,"m",Mn).call(this))}[(Pn=new WeakMap,Cn=new WeakMap,kn=new WeakMap,On=new WeakSet,Rn=function(){this.ended||Bn(this,kn,void 0,"f")},Tn=function(e){let t=Fn(this,Cn,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},Fn(this,Cn,"f")[e.index]=t,t)},Dn=function(e){if(this.ended)return;const t=Fn(this,On,"m",qn).call(this,e);this._emit("chunk",e,t);for(const n of e.choices){const e=t.choices[n.index];null!=n.delta.content&&"assistant"===e.message?.role&&e.message?.content&&(this._emit("content",n.delta.content,e.message.content),this._emit("content.delta",{delta:n.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=n.delta.refusal&&"assistant"===e.message?.role&&e.message?.refusal&&this._emit("refusal.delta",{delta:n.delta.refusal,snapshot:e.message.refusal}),null!=n.logprobs?.content&&"assistant"===e.message?.role&&this._emit("logprobs.content.delta",{content:n.logprobs?.content,snapshot:e.logprobs?.content??[]}),null!=n.logprobs?.refusal&&"assistant"===e.message?.role&&this._emit("logprobs.refusal.delta",{refusal:n.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});const s=Fn(this,On,"m",Tn).call(this,e);e.finish_reason&&(Fn(this,On,"m",$n).call(this,e),null!=s.current_tool_call_index&&Fn(this,On,"m",Nn).call(this,e,s.current_tool_call_index));for(const t of n.delta.tool_calls??[])s.current_tool_call_index!==t.index&&(Fn(this,On,"m",$n).call(this,e),null!=s.current_tool_call_index&&Fn(this,On,"m",Nn).call(this,e,s.current_tool_call_index)),s.current_tool_call_index=t.index;for(const t of n.delta.tool_calls??[]){const n=e.message.tool_calls?.[t.index];n?.type&&("function"===n?.type&&this._emit("tool_calls.function.arguments.delta",{name:n.function?.name,index:t.index,arguments:n.function.arguments,parsed_arguments:n.function.parsed_arguments,arguments_delta:t.function?.arguments??""}))}}},Nn=function(e,t){if(Fn(this,On,"m",Tn).call(this,e).done_tool_calls.has(t))return;const n=e.message.tool_calls?.[t];if(!n)throw new Error("no tool call snapshot");if(!n.type)throw new Error("tool call snapshot missing `type`");if("function"===n.type){const e=Fn(this,Pn,"f")?.tools?.find((e=>"function"===e.type&&e.function.name===n.function.name));this._emit("tool_calls.function.arguments.done",{name:n.function.name,index:t,arguments:n.function.arguments,parsed_arguments:zt(e)?e.$parseRaw(n.function.arguments):e?.function.strict?JSON.parse(n.function.arguments):null})}else n.type},$n=function(e){const t=Fn(this,On,"m",Tn).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const n=Fn(this,On,"m",jn).call(this);this._emit("content.done",{content:e.message.content,parsed:n?n.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},Mn=function(){if(this.ended)throw new Ie("stream has ended, this shouldn't happen");const e=Fn(this,kn,"f");if(!e)throw new Ie("request ended without sending any chunks");return Bn(this,kn,void 0,"f"),Bn(this,Cn,[],"f"),function(e,t){const{id:n,choices:s,created:r,model:o,system_fingerprint:i,...a}=e,l={...a,id:n,choices:s.map((({message:t,finish_reason:n,index:s,logprobs:r,...o})=>{if(!n)throw new Ie(`missing finish_reason for choice ${s}`);const{content:i=null,function_call:a,tool_calls:l,...c}=t,u=t.role;if(!u)throw new Ie(`missing role for choice ${s}`);if(a){const{arguments:e,name:l}=a;if(null==e)throw new Ie(`missing function_call.arguments for choice ${s}`);if(!l)throw new Ie(`missing function_call.name for choice ${s}`);return{...o,message:{content:i,function_call:{arguments:e,name:l},role:u,refusal:t.refusal??null},finish_reason:n,index:s,logprobs:r}}return l?{...o,index:s,finish_reason:n,logprobs:r,message:{...c,role:u,content:i,refusal:t.refusal??null,tool_calls:l.map(((t,n)=>{const{function:r,type:o,id:i,...a}=t,{arguments:l,name:c,...u}=r||{};if(null==i)throw new Ie(`missing choices[${s}].tool_calls[${n}].id\n${Un(e)}`);if(null==o)throw new Ie(`missing choices[${s}].tool_calls[${n}].type\n${Un(e)}`);if(null==c)throw new Ie(`missing choices[${s}].tool_calls[${n}].function.name\n${Un(e)}`);if(null==l)throw new Ie(`missing choices[${s}].tool_calls[${n}].function.arguments\n${Un(e)}`);return{...a,id:i,type:o,function:{...u,name:c,arguments:l}}}))}}:{...o,message:{...c,content:i,role:u,refusal:t.refusal??null},finish_reason:n,index:s,logprobs:r}})),created:r,model:o,object:"chat.completion",...i?{system_fingerprint:i}:{}};return function(e,t){return t&&Zt(t)?Gt(e,t):{...e,choices:e.choices.map((e=>({...e,message:{...e.message,parsed:null,tool_calls:e.message.tool_calls??[]}})))}}(l,t)}(e,Fn(this,Pn,"f"))},jn=function(){const e=Fn(this,Pn,"f")?.response_format;return Kt(e)?e:null},qn=function(e){var t,n,s,r;let o=Fn(this,kn,"f");const{choices:i,...a}=e;o?Object.assign(o,a):o=Bn(this,kn,{...a,choices:[]},"f");for(const{delta:i,finish_reason:a,index:l,logprobs:c=null,...u}of e.choices){let e=o.choices[l];if(e||(e=o.choices[l]={finish_reason:a,index:l,message:{},logprobs:c,...u}),c)if(e.logprobs){const{content:s,refusal:r,...o}=c;Object.assign(e.logprobs,o),s&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...s)),r&&((n=e.logprobs).refusal??(n.refusal=[]),e.logprobs.refusal.push(...r))}else e.logprobs=Object.assign({},c);if(a&&(e.finish_reason=a,Fn(this,Pn,"f")&&Zt(Fn(this,Pn,"f")))){if("length"===a)throw new Be;if("content_filter"===a)throw new Fe}if(Object.assign(e,u),!i)continue;const{content:d,refusal:h,function_call:p,role:f,tool_calls:m,...y}=i;if(Object.assign(e.message,y),h&&(e.message.refusal=(e.message.refusal||"")+h),f&&(e.message.role=f),p&&(e.message.function_call?(p.name&&(e.message.function_call.name=p.name),p.arguments&&((s=e.message.function_call).arguments??(s.arguments=""),e.message.function_call.arguments+=p.arguments)):e.message.function_call=p),d&&(e.message.content=(e.message.content||"")+d,!e.message.refusal&&Fn(this,On,"m",jn).call(this)&&(e.message.parsed=In(e.message.content))),m){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:n,type:s,function:o,...i}of m){const a=(r=e.message.tool_calls)[t]??(r[t]={});Object.assign(a,i),n&&(a.id=n),s&&(a.type=s),o&&(a.function??(a.function={name:o.name??"",arguments:""})),o?.name&&(a.function.name=o.name),o?.arguments&&(a.function.arguments+=o.arguments,Yt(Fn(this,Pn,"f"),a)&&(a.function.parsed_arguments=In(a.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",(n=>{const s=t.shift();s?s.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0}));return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new N(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Un(e){return JSON.stringify(e)}class Wn extends Ln{static fromReadableStream(e){const t=new Wn(null);return t._run((()=>t._fromReadableStream(e))),t}static runFunctions(e,t,n){const s=new Wn(null),r={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run((()=>s._runFunctions(e,t,r))),s}static runTools(e,t,n){const s=new Wn(t),r={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run((()=>s._runTools(e,t,r))),s}}class Xn extends ot{parse(e,t){return function(e){for(const t of e??[]){if("function"!==t.type)throw new Ie(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new Ie(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap((t=>Gt(t,e)))}runFunctions(e,t){return e.stream?Wn.runFunctions(this._client,e,t):hn.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?Wn.runTools(this._client,e,t):hn.runTools(this._client,e,t)}stream(e,t){return Ln.createChatCompletion(this._client,e,t)}}class Jn extends ot{constructor(){super(...arguments),this.completions=new Xn(this._client)}}!function(e){e.Completions=Xn}(Jn||(Jn={}));var Hn,Vn,Kn,zn,Gn,Qn,Yn,Zn,es,ts,ns,ss,rs,os,is,as,ls,cs,us,ds,hs,ps,fs=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)},ms=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n};class ys extends Vt{constructor(){super(...arguments),Hn.add(this),Vn.set(this,[]),Kn.set(this,{}),zn.set(this,{}),Gn.set(this,void 0),Qn.set(this,void 0),Yn.set(this,void 0),Zn.set(this,void 0),es.set(this,void 0),ts.set(this,void 0),ns.set(this,void 0),ss.set(this,void 0),rs.set(this,void 0)}[(Vn=new WeakMap,Kn=new WeakMap,zn=new WeakMap,Gn=new WeakMap,Qn=new WeakMap,Yn=new WeakMap,Zn=new WeakMap,es=new WeakMap,ts=new WeakMap,ns=new WeakMap,ss=new WeakMap,rs=new WeakMap,Hn=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",(n=>{const s=t.shift();s?s.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0}));return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new ys;return t._run((()=>t._fromReadableStream(e))),t}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),this._connected();const s=N.fromReadableStream(e,this.controller);for await(const e of s)fs(this,Hn,"m",os).call(this,e);if(s.controller.signal?.aborted)throw new Pe;return this._addRun(fs(this,Hn,"m",is).call(this))}toReadableStream(){return new N(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,s,r){const o=new ys;return o._run((()=>o._runToolAssistantStream(e,t,n,s,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}}))),o}async _createToolAssistantStream(e,t,n,s,r){const o=r?.signal;o&&(o.aborted&&this.controller.abort(),o.addEventListener("abort",(()=>this.controller.abort())));const i={...s,stream:!0},a=await e.submitToolOutputs(t,n,i,{...r,signal:this.controller.signal});this._connected();for await(const e of a)fs(this,Hn,"m",os).call(this,e);if(a.controller.signal?.aborted)throw new Pe;return this._addRun(fs(this,Hn,"m",is).call(this))}static createThreadAssistantStream(e,t,n){const s=new ys;return s._run((()=>s._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),s}static createAssistantStream(e,t,n,s){const r=new ys;return r._run((()=>r._runAssistantStream(e,t,n,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}currentEvent(){return fs(this,ns,"f")}currentRun(){return fs(this,ss,"f")}currentMessageSnapshot(){return fs(this,Gn,"f")}currentRunStepSnapshot(){return fs(this,rs,"f")}async finalRunSteps(){return await this.done(),Object.values(fs(this,Kn,"f"))}async finalMessages(){return await this.done(),Object.values(fs(this,zn,"f"))}async finalRun(){if(await this.done(),!fs(this,Qn,"f"))throw Error("Final run was not received.");return fs(this,Qn,"f")}async _createThreadAssistantStream(e,t,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",(()=>this.controller.abort())));const r={...t,stream:!0},o=await e.createAndRun(r,{...n,signal:this.controller.signal});this._connected();for await(const e of o)fs(this,Hn,"m",os).call(this,e);if(o.controller.signal?.aborted)throw new Pe;return this._addRun(fs(this,Hn,"m",is).call(this))}async _createAssistantStream(e,t,n,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort())));const o={...n,stream:!0},i=await e.create(t,o,{...s,signal:this.controller.signal});this._connected();for await(const e of i)fs(this,Hn,"m",os).call(this,e);if(i.controller.signal?.aborted)throw new Pe;return this._addRun(fs(this,Hn,"m",is).call(this))}static accumulateDelta(e,t){for(const[n,s]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=s;continue}let t=e[n];if(null!=t)if("index"!==n&&"type"!==n){if("string"==typeof t&&"string"==typeof s)t+=s;else if("number"==typeof t&&"number"==typeof s)t+=s;else{if(!Ae(t)||!Ae(s)){if(Array.isArray(t)&&Array.isArray(s)){if(t.every((e=>"string"==typeof e||"number"==typeof e))){t.push(...s);continue}for(const e of s){if(!Ae(e))throw new Error(`Expected array delta entry to be an object but got: ${e}`);const n=e.index;if(null==n)throw console.error(e),new Error("Expected array delta entry to have an `index` property");if("number"!=typeof n)throw new Error(`Expected array delta entry \`index\` property to be a number but got ${n}`);const s=t[n];null==s?t.push(e):t[n]=this.accumulateDelta(s,e)}continue}throw Error(`Unhandled record type: ${n}, deltaValue: ${s}, accValue: ${t}`)}t=this.accumulateDelta(t,s)}e[n]=t}else e[n]=s;else e[n]=s}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,s){return await this._createAssistantStream(t,e,n,s)}async _runToolAssistantStream(e,t,n,s,r){return await this._createToolAssistantStream(n,e,t,s,r)}}os=function(e){if(!this.ended)switch(ms(this,ns,e,"f"),fs(this,Hn,"m",cs).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":fs(this,Hn,"m",ps).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":fs(this,Hn,"m",ls).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":fs(this,Hn,"m",as).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},is=function(){if(this.ended)throw new Ie("stream has ended, this shouldn't happen");if(!fs(this,Qn,"f"))throw Error("Final run has not been received");return fs(this,Qn,"f")},as=function(e){const[t,n]=fs(this,Hn,"m",ds).call(this,e,fs(this,Gn,"f"));ms(this,Gn,t,"f"),fs(this,zn,"f")[t.id]=t;for(const e of n){const n=t.content[e.index];"text"==n?.type&&this._emit("textCreated",n.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const n of e.data.delta.content){if("text"==n.type&&n.text){let e=n.text,s=t.content[n.index];if(!s||"text"!=s.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,s.text)}if(n.index!=fs(this,Yn,"f")){if(fs(this,Zn,"f"))switch(fs(this,Zn,"f").type){case"text":this._emit("textDone",fs(this,Zn,"f").text,fs(this,Gn,"f"));break;case"image_file":this._emit("imageFileDone",fs(this,Zn,"f").image_file,fs(this,Gn,"f"))}ms(this,Yn,n.index,"f")}ms(this,Zn,t.content[n.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==fs(this,Yn,"f")){const t=e.data.content[fs(this,Yn,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,fs(this,Gn,"f"));break;case"text":this._emit("textDone",t.text,fs(this,Gn,"f"))}}fs(this,Gn,"f")&&this._emit("messageDone",e.data),ms(this,Gn,void 0,"f")}},ls=function(e){const t=fs(this,Hn,"m",us).call(this,e);switch(ms(this,rs,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&"tool_calls"==n.step_details.type&&n.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of n.step_details.tool_calls)e.index==fs(this,es,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(fs(this,ts,"f")&&this._emit("toolCallDone",fs(this,ts,"f")),ms(this,es,e.index,"f"),ms(this,ts,t.step_details.tool_calls[e.index],"f"),fs(this,ts,"f")&&this._emit("toolCallCreated",fs(this,ts,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":ms(this,rs,void 0,"f");"tool_calls"==e.data.step_details.type&&fs(this,ts,"f")&&(this._emit("toolCallDone",fs(this,ts,"f")),ms(this,ts,void 0,"f")),this._emit("runStepDone",e.data,t)}},cs=function(e){fs(this,Vn,"f").push(e),this._emit("event",e)},us=function(e){switch(e.event){case"thread.run.step.created":return fs(this,Kn,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=fs(this,Kn,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const s=ys.accumulateDelta(t,n.delta);fs(this,Kn,"f")[e.data.id]=s}return fs(this,Kn,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":fs(this,Kn,"f")[e.data.id]=e.data}if(fs(this,Kn,"f")[e.data.id])return fs(this,Kn,"f")[e.data.id];throw new Error("No snapshot available")},ds=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(const e of s.delta.content)if(e.index in t.content){let n=t.content[e.index];t.content[e.index]=fs(this,Hn,"m",hs).call(this,e,n)}else t.content[e.index]=e,n.push(e);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},hs=function(e,t){return ys.accumulateDelta(t,e)},ps=function(e){switch(ms(this,ss,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.cancelling":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":ms(this,Qn,e.data,"f"),fs(this,ts,"f")&&(this._emit("toolCallDone",fs(this,ts,"f")),ms(this,ts,void 0,"f"))}};class gs extends ot{create(e,t,n){return this._client.post(`/threads/${e}/messages`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,s){return this._client.post(`/threads/${e}/messages/${t}`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,ws,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class ws extends rt{}!function(e){e.MessagesPage=ws}(gs||(gs={}));class bs extends ot{retrieve(e,t,n,s={},r){return ie(s)?this.retrieve(e,t,n,{},s):this._client.get(`/threads/${e}/runs/${t}/steps/${n}`,{query:s,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t,n={},s){return ie(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,_s,{query:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}}class _s extends rt{}!function(e){e.RunStepsPage=_s}(bs||(bs={}));class vs extends ot{constructor(){super(...arguments),this.steps=new bs(this._client)}create(e,t,n){const{include:s,...r}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:s},body:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:t.stream??!1})}retrieve(e,t,n){return this._client.get(`/threads/${e}/runs/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,s){return this._client.post(`/threads/${e}/runs/${t}`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,Es,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const s=await this.create(e,t,n);return await this.poll(e,s.id,n)}createAndStream(e,t,n){return ys.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:r,response:o}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...s}}).withResponse();switch(r.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=o.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await me(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return r}}}stream(e,t,n){return ys.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n,s){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,t,n,s){const r=await this.submitToolOutputs(e,t,n,s);return await this.poll(e,r.id,s)}submitToolOutputsStream(e,t,n,s){return ys.createToolAssistantStream(e,t,this._client.beta.threads.runs,n,s)}}class Es extends rt{}!function(e){e.RunsPage=Es,e.Steps=bs,e.RunStepsPage=_s}(vs||(vs={}));class Ss extends ot{constructor(){super(...arguments),this.runs=new vs(this._client),this.messages=new gs(this._client)}create(e={},t){return ie(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/threads/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.thread_id,n.id,t)}createAndRunStream(e,t){return ys.createThreadAssistantStream(e,this._client.beta.threads,t)}}!function(e){e.Runs=vs,e.RunsPage=Es,e.Messages=gs,e.MessagesPage=ws}(Ss||(Ss={}));class xs extends ot{create(e,t,n){return this._client.post(`/vector_stores/${e}/files`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,As,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const s=await this.create(e,t,n);return await this.poll(e,s.id,n)}async poll(e,t,n){const s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const r=await this.retrieve(e,t,{...n,headers:s}).withResponse(),o=r.data;switch(o.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=r.response.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await me(e);break;case"failed":case"completed":return o}}}async upload(e,t,n){const s=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:s.id},n)}async uploadAndPoll(e,t,n){const s=await this.upload(e,t,n);return await this.poll(e,s.id,n)}}class As extends rt{}!function(e){e.VectorStoreFilesPage=As}(xs||(xs={}));class Is extends ot{create(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const s=await this.create(e,t);return await this.poll(e,s.id,n)}listFiles(e,t,n={},s){return ie(n)?this.listFiles(e,t,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,As,{query:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}async poll(e,t,n){const s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:r,response:o}=await this.retrieve(e,t,{...n,headers:s}).withResponse();switch(r.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=o.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await me(e);break;case"failed":case"cancelled":case"completed":return r}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},s){if(null==t||0==t.length)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const r=s?.maxConcurrency??5,o=Math.min(r,t.length),i=this._client,a=t.values(),l=[...n];const c=Array(o).fill(a).map((async function(e){for(let t of e){const e=await i.files.create({file:t,purpose:"assistants"},s);l.push(e.id)}}));return await(async e=>{const t=await Promise.allSettled(e),n=t.filter((e=>"rejected"===e.status));if(n.length){for(const e of n)console.error(e.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const s=[];for(const e of t)"fulfilled"===e.status&&s.push(e.value);return s})(c),await this.createAndPoll(e,{file_ids:l})}}Is||(Is={});class Os extends ot{constructor(){super(...arguments),this.files=new xs(this._client),this.fileBatches=new Is(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/vector_stores/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/vector_stores",Ps,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Ps extends rt{}!function(e){e.VectorStoresPage=Ps,e.Files=xs,e.VectorStoreFilesPage=As,e.FileBatches=Is}(Os||(Os={}));class Cs extends ot{constructor(){super(...arguments),this.vectorStores=new Os(this._client),this.chat=new Jn(this._client),this.assistants=new It(this._client),this.threads=new Ss(this._client)}}!function(e){e.VectorStores=Os,e.VectorStoresPage=Ps,e.Chat=Jn,e.Assistants=It,e.AssistantsPage=Ot,e.Threads=Ss}(Cs||(Cs={}));class ks extends ot{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/batches",Rs,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class Rs extends rt{}!function(e){e.BatchesPage=Rs}(ks||(ks={}));class Ts extends ot{create(e,t,n){return this._client.post(`/uploads/${e}/parts`,H({body:t,...n}))}}Ts||(Ts={});class Ds extends ot{constructor(){super(...arguments),this.parts=new Ts(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(`/uploads/${e}/complete`,{body:t,...n})}}var Ns;!function(e){e.Parts=Ts}(Ds||(Ds={}));class $s extends te{constructor({baseURL:e=we("OPENAI_BASE_URL"),apiKey:t=we("OPENAI_API_KEY"),organization:n=we("OPENAI_ORG_ID")??null,project:s=we("OPENAI_PROJECT_ID")??null,...r}={}){if(void 0===t)throw new Ie("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const o={apiKey:t,organization:n,project:s,...r,baseURL:e||"https://api.openai.com/v1"};if(!o.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new Ie("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");super({baseURL:o.baseURL,timeout:o.timeout??6e5,httpAgent:o.httpAgent,maxRetries:o.maxRetries,fetch:o.fetch}),this.completions=new it(this),this.chat=new lt(this),this.embeddings=new ct(this),this.files=new ut(this),this.images=new ht(this),this.audio=new yt(this),this.moderations=new gt(this),this.models=new wt(this),this.fineTuning=new At(this),this.beta=new Cs(this),this.batches=new ks(this),this.uploads=new Ds(this),this._options=o,this.apiKey=t,this.organization=n,this.project=s}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return nt(e,{arrayFormat:"brackets"})}}Ns=$s,$s.OpenAI=Ns,$s.DEFAULT_TIMEOUT=6e5,$s.OpenAIError=Ie,$s.APIError=Oe,$s.APIConnectionError=Ce,$s.APIConnectionTimeoutError=ke,$s.APIUserAbortError=Pe,$s.NotFoundError=Ne,$s.ConflictError=$e,$s.RateLimitError=je,$s.BadRequestError=Re,$s.AuthenticationError=Te,$s.InternalServerError=qe,$s.PermissionDeniedError=De,$s.UnprocessableEntityError=Me,$s.toFile=U,$s.fileFromPath=A;const{vc:Ms,LG:js,xX:qs,qA:Bs,cH:Fs,m_:Ls,fK:Us,OE:Ws,v7:Xs,v3:Js,PO:Hs,Ll:Vs,Is:Ks}=n;!function(e){e.Page=st,e.CursorPage=rt,e.Completions=it,e.Chat=lt,e.Embeddings=ct,e.Files=ut,e.FileObjectsPage=dt,e.Images=ht,e.Audio=yt,e.Moderations=gt,e.Models=wt,e.ModelsPage=bt,e.FineTuning=At,e.Beta=Cs,e.Batches=ks,e.BatchesPage=Rs,e.Uploads=Ds}($s||($s={}));new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations"]);const zs=$s;var Gs=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}l((s=s.apply(e,t||[])).next())}))},Qs=function(e){return this instanceof Qs?(this.v=e,this):new Qs(e)},Ys=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},s("next"),s("throw"),s("return"),t[Symbol.asyncIterator]=function(){return this},t);function s(n){t[n]=e[n]&&function(t){return new Promise((function(s,r){(function(e,t,n,s){Promise.resolve(s).then((function(t){e({value:t,done:n})}),t)})(s,r,(t=e[n](t)).done,t.value)}))}}},Zs=function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,r=n.apply(e,t||[]),o=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s;function i(e){r[e]&&(s[e]=function(t){return new Promise((function(n,s){o.push([e,t,n,s])>1||a(e,t)}))})}function a(e,t){try{(n=r[e](t)).value instanceof Qs?Promise.resolve(n.value.v).then(l,c):u(o[0][2],n)}catch(e){u(o[0][3],e)}var n}function l(e){a("next",e)}function c(e){a("throw",e)}function u(e,t){e(t),o.shift(),o.length&&a(o[0][0],o[0][1])}};class er{constructor(e){this.config=e,this.client=new zs({apiKey:this.config.apiKey,dangerouslyAllowBrowser:!0})}generate(e){var t,n;return Gs(this,void 0,void 0,(function*(){try{const s=e.map((e=>({role:e.role,content:e.content}))),r=yield this.client.chat.completions.create({model:this.config.model,messages:s,temperature:this.config.temperature||.7});return(null===(n=null===(t=r.choices[0])||void 0===t?void 0:t.message)||void 0===n?void 0:n.content)||""}catch(e){throw console.error("OpenAI API error:",e),this.handleAPIError(e),e}}))}generateStream(e){var t,n,s;return Zs(this,arguments,(function*(){var r,o,i,a;try{const d=e.map((e=>({role:e.role,content:e.content}))),h=yield Qs(this.client.chat.completions.create({model:this.config.model,messages:d,temperature:this.config.temperature||.7,stream:!0}));try{for(var l,c=!0,u=Ys(h);!(r=(l=yield Qs(u.next())).done);){a=l.value,c=!1;try{const e=a,r=(null===(n=null===(t=e.choices[0])||void 0===t?void 0:t.delta)||void 0===n?void 0:n.content)||"",o="stop"===(null===(s=e.choices[0])||void 0===s?void 0:s.finish_reason);yield yield Qs({content:r,isComplete:o})}finally{c=!0}}}catch(e){o={error:e}}finally{try{c||r||!(i=u.return)||(yield Qs(i.call(u)))}finally{if(o)throw o.error}}}catch(e){console.error("OpenAI streaming error:",e),this.handleAPIError(e)}}))}handleAPIError(t){throw 401===t.status?new o({type:e.AUTHENTICATION,message:"Invalid OpenAI API key. Please check your API key in the extension options."}):429===t.status?new o({type:e.QUOTA_EXCEEDED,message:"OpenAI API rate limit exceeded. Please try again later."}):404===t.status?new o({type:e.MODEL_ACCESS,message:`The requested model "${this.config.model}" is not available with your API key.`}):new o({type:e.SERVER,message:`Error calling OpenAI API: ${t.message||"Unknown error"}`,details:t})}}var tr,nr=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}l((s=s.apply(e,t||[])).next())}))},sr=function(e){return this instanceof sr?(this.v=e,this):new sr(e)},rr=function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,r=n.apply(e,t||[]),o=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s;function i(e){r[e]&&(s[e]=function(t){return new Promise((function(n,s){o.push([e,t,n,s])>1||a(e,t)}))})}function a(e,t){try{(n=r[e](t)).value instanceof sr?Promise.resolve(n.value.v).then(l,c):u(o[0][2],n)}catch(e){u(o[0][3],e)}var n}function l(e){a("next",e)}function c(e){a("throw",e)}function u(e,t){e(t),o.shift(),o.length&&a(o[0][0],o[0][1])}};class or{constructor(e){this.baseUrl="https://api.deepseek.com/v1",this.config=e}generate(t){var n,s;return nr(this,void 0,void 0,(function*(){try{const e=t.map((e=>({role:e.role,content:e.content}))),r=yield fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({model:this.config.model,messages:e,temperature:this.config.temperature||.7})});r.ok||(yield this.handleResponseError(r));const o=yield r.json();return(null===(s=null===(n=o.choices[0])||void 0===n?void 0:n.message)||void 0===s?void 0:s.content)||""}catch(t){if(console.error("DeepSeek API error:",t),t instanceof o)throw t;throw new o({type:e.SERVER,message:`Error calling DeepSeek API: ${t.message||"Unknown error"}`,details:t})}}))}generateStream(t){var n,s,r;return rr(this,arguments,(function*(){try{const i=t.map((e=>({role:e.role,content:e.content}))),a=yield sr(fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({model:this.config.model,messages:i,temperature:this.config.temperature||.7,stream:!0})}));if(a.ok||(yield sr(this.handleResponseError(a))),!a.body)throw new o({type:e.SERVER,message:"DeepSeek API returned empty response stream"});const l=a.body.getReader(),c=new TextDecoder("utf-8");let u="";for(;;){const{done:e,value:t}=yield sr(l.read());if(e)break;u+=c.decode(t,{stream:!0});const o=u.split("\n");u=o.pop()||"";for(const e of o)if(e.startsWith("data: ")){const t=e.slice(6);if("[DONE]"===t)return yield yield sr({content:"",isComplete:!0}),yield sr(void 0);try{const e=JSON.parse(t),o=(null===(s=null===(n=e.choices[0])||void 0===n?void 0:n.delta)||void 0===s?void 0:s.content)||"",i="stop"===(null===(r=e.choices[0])||void 0===r?void 0:r.finish_reason);if(yield yield sr({content:o,isComplete:i}),i)return yield sr(void 0)}catch(e){console.error("Error parsing SSE data:",e)}}}}catch(t){if(console.error("DeepSeek streaming error:",t),t instanceof o)throw t;throw new o({type:e.SERVER,message:`Error streaming from DeepSeek API: ${t.message||"Unknown error"}`,details:t})}}))}handleResponseError(t){var n;return nr(this,void 0,void 0,(function*(){const s=yield t.json().catch((()=>({})));throw 401===t.status?new o({type:e.AUTHENTICATION,message:"Invalid DeepSeek API key. Please check your API key in the extension options."}):429===t.status?new o({type:e.QUOTA_EXCEEDED,message:"DeepSeek API rate limit exceeded. Please try again later."}):404===t.status?new o({type:e.MODEL_ACCESS,message:`The requested model "${this.config.model}" is not available with your API key.`}):new o({type:e.SERVER,message:`DeepSeek API error (${t.status}): ${(null===(n=s.error)||void 0===n?void 0:n.message)||"Unknown error"}`,details:s})}))}}!function(e){e.OPENAI="openai",e.DEEPSEEK="deepseek"}(tr||(tr={}));const ir=[{id:"gpt-4o-mini",name:"GPT-4o Mini",provider:tr.OPENAI,description:"Smaller, faster version of GPT-4o"},{id:"gpt-4o",name:"GPT-4o",provider:tr.OPENAI,description:"Latest OpenAI multimodal model"},{id:"deepseek-chat",name:"DeepSeek Chat",provider:tr.DEEPSEEK,description:"DeepSeek chat assistant model"},{id:"deepseek-reasoner",name:"DeepSeek R1",provider:tr.DEEPSEEK,description:"Specialized in code generation and understanding"}];function ar(e){return ir.find((t=>t.id===e))}class lr{static createModel(t){switch(t.provider){case tr.OPENAI:return new er(t);case tr.DEEPSEEK:return new or(t);default:throw new o({type:e.CONFIGURATION,message:`Unsupported model provider: ${t.provider}`})}}static createModelFromId(t,n,s){const r=ar(t);if(!r)throw new o({type:e.CONFIGURATION,message:`Unknown model ID: ${t}`});const i={provider:r.provider,model:t,apiKey:n,temperature:s};return this.createModel(i)}}const cr=' You are an expert AI agent that looks at a simplified jupyter notebook and a user request, and provides a list of cell IDs that are essential for addressing the request.\nThe notebook code is signicantly simplified. Some of the simplifications are:\n- Any information within paranthesis is removed (parameters, etc.)\n- Function implementations are removed\nRespond ONLY with a JSON array of cell IDs that are essential for addressing the request. For example, if the request is related to an AI model, the response should include the cell IDs for the model implementation, training, and evaluation.\n\nExample:\n[\n    "cell-1",\n    "cell-2"\n]';var ur=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}l((s=s.apply(e,t||[])).next())}))},dr=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},s("next"),s("throw"),s("return"),t[Symbol.asyncIterator]=function(){return this},t);function s(n){t[n]=e[n]&&function(t){return new Promise((function(s,r){(function(e,t,n,s){Promise.resolve(s).then((function(t){e({value:t,done:n})}),t)})(s,r,(t=e[n](t)).done,t.value)}))}}};let hr;const pr=[],fr=[],mr=[];function yr(t,n,s="gpt-4o-mini"){var i;return ur(this,void 0,void 0,(function*(){try{!function(e){const t=hr||new r;hr=t,t.updateState(e)}(n),function(e){m.buffer="",m.textContent="",m.fullResponse="",m.appliedOperations=new Map,m.currentOperations=new Map,m.isCodeBlock=!1,m.originalContent=e}(n);let a=hr.getLastState([],!1);const{allow_reduce_content:l}=yield chrome.storage.local.get("allow_reduce_content"),c=l&&a.length>1e5;if(console.log("Should reduce content:",c),c){const n=yield function(t,n="gpt-4o-mini"){return ur(this,void 0,void 0,(function*(){try{const s=hr.getLastState([],!0),r=[{role:"system",content:cr},{role:"user",content:`Current notebook state: ${s}\nPrompt: ${t}`}],i=yield function(t,n){return ur(this,void 0,void 0,(function*(){const s=ar(n);if(!s)throw new o({type:e.CONFIGURATION,message:`Unknown model ID: ${n}. Please select a valid model in the settings.`});const r=s.provider,i=r===tr.OPENAI?"openai_api_key":"deepseek_api_key",a=(yield chrome.storage.local.get(i))[i];if(!a)throw new o({type:e.CONFIGURATION,message:`API key for ${r} is not configured. Please set it in the extension options.`});const l=lr.createModelFromId(n,a,.2);try{return yield l.generate(t)}catch(e){throw console.error(`${r} API error:`,e),e}}))}(r,n);try{const e=JSON.parse(i);if(console.log("Required cell IDs:",e),Array.isArray(e)&&e.length>0)return e}catch(e){console.error("Error parsing cell IDs from response:",e);const t=/(cell-\S+)/g,n=i.match(t);if(n&&n.length>0)return n}}catch(e){console.error("Error getting required cell IDs:",e)}return[]}))}(t,s),r=/(cell-\S+)/g;null===(i=t.match(r))||void 0===i||i.forEach((e=>{n.includes(e)||n.push(e)})),a=hr.getLastState(n,!0)}fr.length>3&&fr.shift(),fr.push(t);const u=[];u.push({role:"system",content:'You are ColabAI, an exceptional senior data scientist and python developer with vast knowledge across multiple fields, frameworks, and best practices. Your goal is to help users in creating, optimizing, and managing their Google Colab Notebooks. You can perform the following operations on notebook cells.\n\n<available_operations>\n  <operation description="Create a new cell">\n    @CREATE[type=markdown|code, position=top|bottom|after:cell-{cellId}|before:cell-{cellId}]\n    content\n    @END\n  </operation>\n\n  <operation description="Delete a cell">\n    @DELETE[cell-{cellId}]\n  </operation>\n\n  <operation description="Edit a cell, the content of the cell will be completely replaced">\n    @EDIT[cell-{cellId}]\n    new content\n    @END\n  </operation>\n\n  These are the ONLY operations you can perform on notebook cells. Make sure to follow the correct syntax and structure for each operation.\n</available_operations>\n\n<cell_types>\n  <markdown_cell>\n    - Use formatting: bold, italic, lists, tables\n    - Add context before code cells\n    - Include LaTeX for math equations\n    - Embed diagrams/charts where needed\n  </markdown_cell>\n\n  <code_cell>\n    - Break into logical chunks\n    - Add helpful comments\n    - Use descriptive names\n    - Group related code together\n  </code_cell>\n</cell_types>\n\n<response_format>\n  - All operations must be between @START_CODE and @END_CODE (Don\'t forget the @END_CODE at the end of the operations)\n  - You can write in normal text before and after these markers, explaining what you are doing or replying to the user\n  - Be very brief and clear in your responses before and after the markers. You can write in markdown format here\n  - Always aim to improve the structure of the notebook, removing unneeded cells and reordering content to be logical and coherent\n</response_format>\n\n<examples>\n<example>\n  <user_request>\n    This is the current notebook state for reference: <notebook_state>[{"id": "cell-N8PmTh-BqoUv", "type": "code", "content": ""}]</notebook_state>. I want to learn logistic regression by implementing a model that can determine students\' chance of admission based on their results on two exams. I have historical data from previous applicants and their admission decision. Do logistic regression from scratch.\n  </user_request>\n\n  <your_response>\n    Sure thing, here\'s a step-by-step guide through implementing logistic regression from scratch.\n\n    @START_CODE\n\n    @DELETE[cell-N8PmTh-BqoUv]\n\n    @CREATE[type=markdown, position=top]\n    # Student Admission Predictor\n    @END\n\n    @CREATE[type=markdown, position=bottom]\n    ## Data Analysis\n    let\'s start by examining the data.\n    @END\n\n    @CREATE[type=code, position=bottom]\n    import numpy as np\n    import pandas as pd\n    import matplotlib.pyplot as plt\n    import os\n    %matplotlib inline\n    @END\n\n   @CREATE[type=code, position=bottom]\n    path = "path/to/data"\n    data = pd.read_csv(path, header=None, names=[\'Exam 1\', \'Exam 2\', \'Admitted\']) // Ensure that the column names match\n    data.head()\n    @END\n\n    @CREATE[type=markdown, position=bottom]\n    Let\'s create a scatter plot of the two scores and use color coding to visualize if the example is positive (admitted) or negative (not admitted).\n    @END\n\n    [...]\n\n    @END_CODE\n    \n    This will help you get started with your project. Let me know if you need any more help!\n  </your_response>\n</example>\n\n<example>\n  <user_request>\n    This is the current notebook state for reference: <notebook_state>[{"id":"cell-c8Tf-I25qLtf","type":"markdown","content":"**COE-476 HW3: Classification**\n---\n\n"},{"id":"cell-zcZYJWyMJ4uF","type":"markdown","content":"Q.1. Binary Classification: <br>"},{"id":"cell-uPYNAq2NJ9bJ","type":"markdown","content":"[Q1.1] The images.zip dataset folder contains a binary and a multiclass problems. In this question you are required to read the images in the binary folder to a numpy array X and the labels "folder names" into a numpy array y. Resize all images to 224x224"},{"id":"cell-uK5g0RFjOnex","type":"code","content":"from google.colab import drive\ndrive.mount(\'/content/drive\')"},{"id":"cell-2mm3CI1TWF1D","type":"code","content":"import os\nimport numpy as np\nfrom PIL import Image\n\nbinary_dir = \'/content/drive/MyDrive/Fall 2024/Neural Networks/HW3/Dataset/Binary\'"},{"id":"cell-ByNpG_bWMe-U","type":"markdown","content":"[Q1.2.] Plot the distribution of each class."},{"id":"cell-qIMckEY0WKsm","type":"code","content":""},{"id":"cell-fJxVmV-cMxre","type":"markdown","content":"[Q1.3.] Fit a simple Feed-forward network to perform the classification for you. use the following architecture and replace the missing parameters with appropriate values. Follow a 80-20 train-test split, ensure that your images are normalized between 0-1 and use a batch_size of 2, train for 5 epochs only."},{"id":"cell-9TBiQratWMEz","type":"code","content":""},{"id":"cell-Q-tqp2DligjS","type":"markdown","content":"[Q.1.4.] Print out the classification report for the results obtained"},{"id":"cell-f8cP1l0JXM12","type":"code","content":""}]</notebook_state>. Solve the following questions.\n  </user_request>\n\n  <your_response>\n    I\'ll help you solve these questions step by step. Let\'s start with Q1.1 to read and prepare the image data.\n\n    @START_CODE\n\n    @EDIT[cell-2mm3CI1TWF1D]\n    import os\n    import numpy as np\n    from PIL import Image\n\n    # Path to binary dataset\n    binary_dir = \'/content/drive/MyDrive/Fall 2024/Neural Networks/HW3/Dataset/Binary\'\n\n    # Initialize lists to store images and labels\n    X = []\n    y = []\n\n    # Get class names (folder names)\n    classes = os.listdir(binary_dir)\n\n    # Read images from each class\n    for class_idx, class_name in enumerate(classes):\n        class_path = os.path.join(binary_dir, class_name)\n        \n        # Read all images in the class folder\n        for img_name in os.listdir(class_path):\n            img_path = os.path.join(class_path, img_name)\n            \n            # Open and resize image\n            img = Image.open(img_path)\n            img = img.resize((224, 224))\n            \n            # Convert to numpy array\n            img_array = np.array(img)\n            \n            # Add to lists\n            X.append(img_array)\n            y.append(class_idx)\n\n    # Convert lists to numpy arrays\n    X = np.array(X)\n    y = np.array(y)\n\n    print("Data shape:", X.shape)\n    print("Labels shape:", y.shape)\n    print("Classes:", classes)\n    @END\n\n    @EDIT[cell-qIMckEY0WKsm]\n    import matplotlib.pyplot as plt\n\n    # Count samples in each class\n    unique_classes, counts = np.unique(y, return_counts=True)\n\n    # Create bar plot\n    plt.figure(figsize=(8, 6))\n    plt.bar(classes, counts)\n    plt.title(\'Distribution of Classes\')\n    plt.xlabel(\'Class\')\n    plt.ylabel(\'Number of Samples\')\n    plt.xticks(rotation=45)\n    plt.tight_layout()\n    plt.show()\n\n    print("Class distribution:")\n    for class_name, count in zip(classes, counts):\n        print(f"{class_name}: {count} samples")\n    @END\n\n    @EDIT[cell-9TBiQratWMEz]\n    import tensorflow as tf\n    from sklearn.model_selection import train_test_split\n    from tensorflow.keras import layers, models\n\n    # Normalize the data\n    X = X.astype(\'float32\') / 255.0\n\n    # Split the data\n    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)\n\n    # Build the model\n    model = models.Sequential([\n        layers.Flatten(input_shape=(224, 224, 3)),\n        layers.Dense(128, activation=\'relu\'),\n        layers.Dropout(0.3),\n        layers.Dense(64, activation=\'relu\'),\n        layers.Dropout(0.2),\n        layers.Dense(1, activation=\'sigmoid\')\n    ])\n\n    # Compile the model\n    model.compile(optimizer=\'adam\',\n                  loss=\'binary_crossentropy\',\n                  metrics=[\'accuracy\'])\n\n    # Train the model\n    history = model.fit(X_train, y_train,\n                        batch_size=2,\n                        epochs=5,\n                        validation_data=(X_test, y_test))\n    @END\n\n    @EDIT[cell-f8cP1l0JXM12]\n    from sklearn.metrics import classification_report\n\n    # Get predictions\n    y_pred = model.predict(X_test)\n    y_pred_classes = (y_pred > 0.5).astype(int)\n\n    # Print classification report\n    print("Classification Report:")\n    print(classification_report(y_test, y_pred_classes, target_names=classes))\n\n    # Plot training history\n    plt.figure(figsize=(12, 4))\n\n    plt.subplot(1, 2, 1)\n    plt.plot(history.history[\'loss\'], label=\'Training Loss\')\n    plt.plot(history.history[\'val_loss\'], label=\'Validation Loss\')\n    plt.title(\'Model Loss\')\n    plt.xlabel(\'Epoch\')\n    plt.ylabel(\'Loss\')\n    plt.legend()\n\n    plt.subplot(1, 2, 2)\n    plt.plot(history.history[\'accuracy\'], label=\'Training Accuracy\')\n    plt.plot(history.history[\'val_accuracy\'], label=\'Validation Accuracy\')\n    plt.title(\'Model Accuracy\')\n    plt.xlabel(\'Epoch\')\n    plt.ylabel(\'Accuracy\')\n    plt.legend()\n\n    plt.tight_layout()\n    plt.show()\n    @END\n\n    @END_CODE\n\n    I\'ve implemented all the required components:\n\n    1. Q1.1: Code to read and resize images to 224x224 from the binary folder\n    2. Q1.2: Plot showing the distribution of classes with a bar chart\n    3. Q1.3: Implementation of a feed-forward neural network with:\n      - Input layer (flattened 224x224x3 images)\n      - Two hidden layers (128 and 64 units) with ReLU activation\n      - Dropout layers for regularization\n      - Output layer with sigmoid activation for binary classification\n    4. Q1.4: Classification report and visualization of training history\n\n    Make sure to run the cells in order. The code assumes that your images are in RGB format (3 channels). If they\'re in grayscale, you might need to adjust the input shape accordingly. Let me know if you need any modifications or have questions!\n  </your_response>\n</example>\n</examples>\n\n<important_notes>\n  - Cell IDs must be specified for position-dependent operations. Cell IDs can be found in the notebook, don\'t make up your own (make sure the id matches the one in the notebook exactly)\n  - Operations are executed in sequence\n  - Content between @CREATE/@EDIT and @END maintains original formatting\n  - For code cells, ensure proper indentation is preserved\n  - Focus on brevity and utility in your replies and the changes made.\n  - Remember to ALWAYS have the @END marker at the end of EVERY operation even if @END_CODE is present\n  - DONT add code backticks in code cells like (```python).\n  - Markdown cells should usually be before the cells that they reference\n\n  IMPORTANT: DON\'T perform operations unless the user explicitly requests it\n  IMPORTANT: When inserting cells, make sure to insert them at the correct position (position=bottom will place at the very end of the notebook, not below the last inserted cell)\n  IMPORTANT: You will receive the current cells of the notebook. The cells containing code not deemed important will be condensed.\n  VERY IMPORTANT: DO NOT respond with the condensed code in any of the operations (ie. don\'t have code like model.fit(...) in your response). If you need an expanded version of a cell, request it from the user by asking him to attach the cell required (ex. "Please attach the cell that contains the code for the model implementation by typing @")\n</important_notes>'});for(let e=0;e<fr.length-1;e++)fr[e]&&u.push({role:"user",content:fr[e]}),mr[e]&&u.push({role:"assistant",content:mr[e]});u.push({role:"user",content:`This is the current notebook state for reference: <notebook_state>${a}</notebook_state>. ${t}`}),yield function(t,n){var s,r,i,a;return ur(this,void 0,void 0,(function*(){const l=ar(n);if(!l)throw new o({type:e.CONFIGURATION,message:`Unknown model ID: ${n}. Please select a valid model in the settings.`});const c=l.provider,u=c===tr.OPENAI?"openai_api_key":"deepseek_api_key",d=(yield chrome.storage.local.get(u))[u];if(!d)throw new o({type:e.CONFIGURATION,message:`API key for ${c} is not configured. Please set it in the extension options.`});const h=lr.createModelFromId(n,d,.7);try{let e="";const n=h.generateStream(t);try{for(var p,f=!0,m=dr(n);p=yield m.next(),!(s=p.done);){a=p.value,f=!1;try{const t=a;if(t.content&&(yield y(t.content,!1),e+=t.content),t.isComplete)break}finally{f=!0}}}catch(e){r={error:e}}finally{try{f||s||!(i=m.return)||(yield i.call(m))}finally{if(r)throw r.error}}yield y("",!0),mr.push(e),console.log("Response:",e)}catch(e){throw console.error(`${c} streaming error:`,e),e}}))}(u,s)}catch(t){throw l(),t instanceof TypeError&&t.message.includes("network")&&d({type:e.NETWORK,message:"Network connection error",details:t}),t.type&&Object.values(e).includes(t.type)&&d(t),t}}))}console.log("Background script initialized"),chrome.runtime.onMessage.addListener(((e,t,n)=>{console.log("Background received message:",e);const{action:s,type:o}=e;if("ping"===s)return console.log("Received ping"),n({success:!0}),!0;switch(s){case"generateAI":console.log("Generating AI content...");const t=e.model||"gpt-4o-mini";return yr(e.prompt,e.content,t).then((()=>{n({success:!0})})).catch((e=>{console.error("Error generating AI content:",e),n({success:!1,error:e})})),!0;case"restartAI":return console.log("Restarting AI..."),function(){ur(this,void 0,void 0,(function*(){hr=new r,pr.length=0,fr.length=0,mr.length=0,l()}))}(),n({success:!0}),!0;case"OPEN_POPUP":try{const{popupUrl:t,width:s,height:r,left:o,top:i}=e.payload||{};chrome.windows.create({url:t,type:"popup",width:s||350,height:r||500,left:o||100,top:i||100}),n({success:!0})}catch(e){console.error("Error opening popup:",e),n({success:!1,error:e})}return!0;default:return console.log("Unhandled action:",s),n({success:!1,error:`Invalid action: ${s}`}),!0}}))})();